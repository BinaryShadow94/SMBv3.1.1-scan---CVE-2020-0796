import socket
import binascii
import sys
import struct
from netaddr import IPNetwork

print("CVE-2020-0796 scan - This script scan if the target has SMB version 3.1.1 with compressiÃ³n, posible vulnerable for this CVE --- By BinaryShadow")

pkt = b'\x00\x00\x00\xc0\xfeSMB@\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00$\x00\x08\x00\x01\x00\x00\x00\x7f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00x\x00\x00\x00\x02\x00\x00\x00\x02\x02\x10\x02"\x02$\x02\x00\x03\x02\x03\x10\x03\x11\x03\x00\x00\x00\x00\x01\x00&\x00\x00\x00\x00\x00\x01\x00 \x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\n\x00\x00\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00'

subnet = sys.argv[1]
try:
    for ip in IPNetwork(subnet):
        sock = socket.socket(socket.AF_INET)
        sock.settimeout(3)

        try:
            sock.connect(( str(ip),  445 ))
        except Exception as identifier:
            sock.close()
            print(str(ip) + " " + str(identifier))
            continue

        sock.send(pkt)
        nb = struct.unpack(">I", sock.recv(4))
        res = sock.recv(nb[0])
        #print("All response: " + str(res) + "\n --------------------------")
        #print("Version analize: ",end="")
        #print(binascii.hexlify(res)[-36:])
        if binascii.hexlify(res)[-36:].startswith(b'03'):
            if res[-2:] == b'\x01\x00':
                print(str(ip) + "\tPosible vulnerable: \tTarget support SMBv3.1.1 with LZNT1 compression algorithm")
            if res[-2:] == b'\x02\x00':
                print(str(ip) + "\tPosible vulnerable: \tTarget support SMBv3.1.1 with LZ77 compression algorithm")
            if res[-2:] == b'\x03\x00':
                print(str(ip) + "\tPosible vulnerable: \tTarget support SMBv3.1.1 with LZ77+Huffman compression algorithm")
        if res[68:70] != b"\x11\x03" or res[70:72] != b"\x02\x00":
            print(f"{ip} Not vulnerable.")
except:
    print("Usage: python3 " + argv[0] + " <ip or subnet>")